import { Executable } from "@domain/entities/executable.entity";
import { ExecutableSource } from "@domain/enum/executable-source.enum";
import { IExecutable } from "@domain/interfaces/executable.interface";
import { basename } from "node:path";
import { Inject, Service } from "typedi";
import { Powershell } from "../../utils/powershell";
import { IScanner } from "../../interfaces/scanner.interface";

@Service()
export class ProcessesScanner implements IScanner {
  public name: string = "Running processes";
  public optionName: string = "process";
  public source = ExecutableSource.PROCESS;

  constructor(@Inject() private shell: Powershell) {}

  public async listExecutables(): Promise<IExecutable[]> {
    console.log("Listing processes...");
    // const command = "WMIC PROCESS get ExecutablePath";
    const output = await this.shell.run(["WMIC", "PROCESS", "get", "ExecutablePath"]);
    const outputArr = output.split("\n");
    const executables = new Set<IExecutable>();

    for (let i = 0; i < outputArr.length; i++) {
      const line = outputArr[i];
      const filePath = line.trim();
      if (!filePath.length || filePath === "ExecutablePath") {
        continue;
      }

      const processBaseName = basename(filePath);

      executables.add(new Executable(processBaseName, filePath, ExecutableSource.PROCESS, ""));
    }

    return Array.from(executables);
  }
}
