import { actions } from './processListActions'
const _KEY_ = "__VTP"

const INITIAL_STATE = {
   list: getCurrentList(),
   loading: false
}

function getCurrentList() {
   return JSON.parse(localStorage.getItem(_KEY_) || '[]')
}

function setCurrentList(list) {
   localStorage.setItem(_KEY_, JSON.stringify(list))
}

export default (state = INITIAL_STATE, action) => {
   let process = null
   switch(action.type) {
      case actions.GET_PROCESS_LIST:
         let oldList = getCurrentList().map(p => { p.running = false; return p; })
         let list = action.payload
         for (let p of list) {
            if (!oldList.find(e => e.hash == p.hash)) {
               p.running = true
               oldList.push(p)
            }
         }
         for (let p of oldList) {
            p.running = !!list.find(e => e.hash == p.hash)
         }
         setCurrentList(oldList)
         return { ...state, list: oldList}
      case actions.LOADING:
         return { ...state, loading: action.payload }
      case actions.PROCESS_LOADING:
         process = state.list.find(p => p.hash == action.payload.hash)
         if (process) {
            process.loading = action.payload.flag
         }
         return { ...state }
      case actions.CLEAR_LIST:
         setCurrentList([])
         return { ...state, list: [] }
      case actions.PROCESS_REPORT:
         let danger = action.payload.stats.malicious > 0 ? 2 : action.payload.stats.suspicious > 0 ? 1 : 0
         process = state.list.find(p => p.hash == action.payload.hash)
         process.danger = danger
         process.reportUrl = action.payload.reportUrl
         setCurrentList(state.list)
         return { ...state }
      default:
         return state
   }
}